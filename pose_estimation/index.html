<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Pose Estimation with ml5.js</title>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            text-align: center;
            color: #00d4ff;
        }
        .video-wrapper {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .video-container, .skeleton-container {
            flex: 1;
            max-width: 640px;
        }
        .video-container h3, .skeleton-container h3 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 10px;
        }
        #video {
            display: block;
            width: 100%;
            background: #000;
        }
        #skeletonCanvas {
            display: block;
            width: 100%;
            background: #000;
            border: 2px solid #00d4ff;
            border-radius: 5px;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background: #00d4ff;
            border: none;
            border-radius: 5px;
            color: #1a1a2e;
        }
        button:hover {
            background: #00a8cc;
        }
        #status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background: #16213e;
            border-radius: 5px;
        }
        #poseData {
            background: #16213e;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>3D Pose Estimation with ml5.js</h1>

    <div id="status">Loading model...</div>

    <div class="controls">
        <button id="playBtn">Play</button>
        <button id="pauseBtn">Pause</button>
        <button id="restartBtn">Restart</button>
    </div>

    <div class="video-wrapper">
        <div class="video-container">
            <h3>Original Video</h3>
            <video id="video" crossorigin="anonymous">
                <source src="../example_outputs/rawvideo_gait_speaktask.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
        <div class="skeleton-container">
            <h3>3D Skeleton</h3>
            <canvas id="skeletonCanvas"></canvas>
        </div>
    </div>

    <h3>Detected Pose Data (3D Coordinates)</h3>
    <div id="poseData">Waiting for pose detection...</div>

    <script>
        let video;
        let skeletonCanvas;
        let ctx;
        let bodyPose;
        let poses = [];
        let tempCanvas;
        let tempCtx;

        // Keypoint connections for MoveNet (17 keypoints)
        // 0:nose, 1:left_eye, 2:right_eye, 3:left_ear, 4:right_ear,
        // 5:left_shoulder, 6:right_shoulder, 7:left_elbow, 8:right_elbow,
        // 9:left_wrist, 10:right_wrist, 11:left_hip, 12:right_hip,
        // 13:left_knee, 14:right_knee, 15:left_ankle, 16:right_ankle
        const connections = [
            // Face
            [0, 1], [0, 2], [1, 3], [2, 4],
            // Torso
            [5, 6], [5, 11], [6, 12], [11, 12],
            // Left arm
            [5, 7], [7, 9],
            // Right arm
            [6, 8], [8, 10],
            // Left leg
            [11, 13], [13, 15],
            // Right leg
            [12, 14], [14, 16]
        ];

        // Initialize
        function init() {
            video = document.getElementById('video');
            skeletonCanvas = document.getElementById('skeletonCanvas');
            ctx = skeletonCanvas.getContext('2d');

            // Create temp canvas for video frame capture
            tempCanvas = document.createElement('canvas');
            tempCtx = tempCanvas.getContext('2d');

            // Setup controls
            setupControls();

            // Wait for video to be ready before loading model
            if (video.readyState >= 2) {
                syncCanvasSize();
                loadModel();
            } else {
                video.addEventListener('loadeddata', () => {
                    console.log('Video loaded, dimensions:', video.videoWidth, video.videoHeight);
                    syncCanvasSize();
                    loadModel();
                });
            }

            // Also sync on video play and resize
            video.addEventListener('play', syncCanvasSize);
            window.addEventListener('resize', syncCanvasSize);
        }

        function syncCanvasSize() {
            // Canvas internal size matches video resolution
            skeletonCanvas.width = video.videoWidth;
            skeletonCanvas.height = video.videoHeight;
        }

        async function loadModel() {
            console.log('Loading ml5.bodyPose model...');
            document.getElementById('status').textContent = 'Loading ML model...';

            try {
                // Initialize ml5 bodyPose with MoveNet - it returns a Promise
                bodyPose = await ml5.bodyPose('MoveNet', video);

                console.log('Model loaded successfully!');
                console.log('bodyPose:', bodyPose);
                console.log('bodyPose methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(bodyPose)));

                document.getElementById('status').textContent = 'Model loaded! Click Play to start.';
                document.getElementById('status').style.background = '#0f3460';

                // Start drawing loop
                requestAnimationFrame(draw);
            } catch (err) {
                console.error('Error loading model:', err);
                document.getElementById('status').textContent = 'Error loading model: ' + err.message;
            }
        }

        function setupControls() {
            document.getElementById('playBtn').addEventListener('click', () => video.play());
            document.getElementById('pauseBtn').addEventListener('click', () => video.pause());
            document.getElementById('restartBtn').addEventListener('click', () => {
                video.currentTime = 0;
                video.play();
            });
        }

        function gotPoses(results) {
            poses = results;
            // Log pose data for debugging
            if (poses.length > 0 && poses[0].keypoints[0]) {
                const nose = poses[0].keypoints[0];
                console.log('Nose:', nose.x.toFixed(1), nose.y.toFixed(1), 'conf:', nose.confidence.toFixed(2));
            }
            // Update data display when new poses arrive
            if (poses.length > 0) {
                updatePoseData(poses[0]);
            }
        }

        let isDetecting = false;

        async function runDetection() {
            if (isDetecting || !bodyPose || video.paused || video.readyState < 2) return;

            isDetecting = true;
            try {
                // Capture frame to temp canvas
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                tempCtx.drawImage(video, 0, 0);

                // Detect poses
                const results = await bodyPose.detect(tempCanvas);
                if (results && results.length > 0) {
                    poses = results;
                    updatePoseData(poses[0]);
                }
            } catch (err) {
                console.error('Detection error:', err);
            }
            isDetecting = false;
        }

        function draw() {
            // Sync canvas size with video's native resolution
            const width = video.videoWidth || 640;
            const height = video.videoHeight || 480;

            if (skeletonCanvas.width !== width || skeletonCanvas.height !== height) {
                skeletonCanvas.width = width;
                skeletonCanvas.height = height;
            }

            // Clear canvas with dark background
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, skeletonCanvas.width, skeletonCanvas.height);

            // Run detection asynchronously (non-blocking)
            runDetection();

            // Show detection status
            if (!video.paused) {
                document.getElementById('status').textContent = `Detecting... Poses found: ${poses.length}`;
            }

            if (poses.length > 0) {
                const pose = poses[0];


                // Draw skeleton connections
                ctx.strokeStyle = '#00d4ff';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';

                for (const [i, j] of connections) {
                    const kpA = pose.keypoints[i];
                    const kpB = pose.keypoints[j];

                    if (kpA && kpB && kpA.confidence > 0.1 && kpB.confidence > 0.1) {
                        ctx.beginPath();
                        ctx.moveTo(kpA.x, kpA.y);
                        ctx.lineTo(kpB.x, kpB.y);
                        ctx.stroke();
                    }
                }

                // Draw keypoints
                for (const keypoint of pose.keypoints) {
                    if (keypoint.confidence > 0.1) {
                        // Bright color for visibility
                        ctx.fillStyle = '#ff0066';

                        ctx.beginPath();
                        ctx.arc(keypoint.x, keypoint.y, 5, 0, 2 * Math.PI);
                        ctx.fill();

                        // Draw white border
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                }

                // Update pose data display
                updatePoseData(pose);
            }

            requestAnimationFrame(draw);
        }

        function updatePoseData(pose) {
            const dataDiv = document.getElementById('poseData');
            let html = '<strong>Keypoints (x, y, z, confidence):</strong><br><br>';

            const keypointNames = [
                'nose', 'left_eye', 'right_eye', 'left_ear', 'right_ear',
                'left_shoulder', 'right_shoulder', 'left_elbow', 'right_elbow',
                'left_wrist', 'right_wrist', 'left_hip', 'right_hip',
                'left_knee', 'right_knee', 'left_ankle', 'right_ankle'
            ];

            for (let i = 0; i < pose.keypoints.length; i++) {
                const kp = pose.keypoints[i];
                const name = keypointNames[i] || `keypoint_${i}`;
                if (kp.confidence > 0.1) {
                    const x = kp.x.toFixed(1);
                    const y = kp.y.toFixed(1);
                    const z = (kp.z || 0).toFixed(3);
                    const conf = kp.confidence.toFixed(2);
                    html += `<span style="color:#00d4ff">${name}:</span> (${x}, ${y}, ${z}) conf: ${conf}<br>`;
                }
            }

            dataDiv.innerHTML = html;
        }

        // Start when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
